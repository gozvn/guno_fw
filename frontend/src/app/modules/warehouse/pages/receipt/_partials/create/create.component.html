<div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner color="primary" [diameter]="40"></mat-spinner>
</div>
<h2 mat-dialog-title class="dialog-header">
    {{ 'warehouse.inventory.receipt.create.title' | translate }}
</h2>
<mat-icon class="btn-close-dialog-icon cursor-pointer"
          mat-dialog-close
          aria-label="Đóng">
    <i mat-dialog-close class="iconify icon-20" data-icon="solar:close-square-bold"></i>
</mat-icon>
<mat-dialog-content class="p-0 m-0 p-l-15 p-r-15 p-t-15 dialog-content cardWithShadow">
    <div class="row overflow-hidden">
        <div class="col-lg-4 p-b-15">
            <mat-card class="cardWithShadow m-b-0">
                <mat-card-header class="p-15">
                    <mat-card-title class="m-b-0 text-black f-s-16">{{ 'labels.info' | translate }}</mat-card-title>
                </mat-card-header>
                <mat-divider></mat-divider>
                <mat-card-content class="p-15">
                    <div class="row m-b-10">
                        <div class="col-sm-12 m-b-20">
                            <mat-form-field class="theme-select m-r-10 input-height-46 d-inline" appearance="outline">
                                <mat-label>{{ 'warehouse.common.receiptType' | translate }}</mat-label>
                                <mat-icon matPrefix class="m-r-0 p-r-0"><i-tabler name="menu" class="icon-20 cursor-pointer"></i-tabler></mat-icon>
                                <mat-select [value]="type" (selectionChange)="onSelectPresetReceiptTypeChange($event)">
                                    <mat-option *ngFor="let preset of presetReceiptTypes" [value]="preset">
                                        <ng-container>
                                            {{ 'warehouse.inventory.receipt.type.' + preset | translate }}
                                        </ng-container>
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col-sm-12 m-b-20">
                            <mat-form-field class="theme-select m-r-10 input-height-46 d-inline" appearance="outline">
                                <mat-label>{{ 'warehouse.common.supplier' | translate }}</mat-label>
                                <mat-icon matPrefix class="m-r-0 p-r-0"><i-tabler name="menu" class="icon-20 cursor-pointer"></i-tabler></mat-icon>
                                <mat-select [value]="supplierCustomId" (selectionChange)="onSelectPresetSupplierChange($event)">
                                    <mat-option *ngFor="let preset of supplierCustomIds" [value]="preset">
                                        {{ getSupplierName(preset) }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col-sm-12 m-b-10">
                            <mat-form-field class="theme-select m-r-10 m-t-20 input-height-46 d-inline" appearance="outline">
                                <mat-label>{{ 'warehouse.common.status' | translate }}</mat-label>
                                <mat-icon matPrefix class="m-r-0 p-r-0"><i-tabler name="progress-help" class="icon-20 cursor-pointer"></i-tabler></mat-icon>
                                <mat-select [value]="status" (selectionChange)="onSelectPresetStatusChange($event)">
                                    <mat-option *ngFor="let preset of presetStatues" [value]="preset">
                                        <ng-container>
                                            {{ 'warehouse.inventory.receipt.status.' + preset | translate }}
                                        </ng-container>
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                        <div class="col-sm-12 d-flex align-items-center">
                            <mat-label class="f-w-600 d-block m-b-10">{{ 'warehouse.common.createdBy' | translate }}</mat-label>
                        </div>
                        <div class="col-sm-12">
                            {{ user.email }}
                        </div>
                    </div>
                    <mat-divider></mat-divider>
                    <div class="row m-b-10 m-t-10">
                        <div class="col-sm-4 d-flex align-items-center m-t-10 ">
                            <mat-label class="f-w-600 d-block">{{ 'warehouse.common.expectedDate' | translate }}</mat-label>
                        </div>
                        <div class="col-sm-8">
                            <mat-form-field appearance="outline" class="m-r-10 d-flex input-height-46 w-100">
                                <input
                                    matInput
                                    [matDatepicker]="picker"
                                    placeholder="{{ 'labels.selectDate' | translate }}"
                                    readonly
                                    [(ngModel)]="expectedDate" />
                                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                                <mat-datepicker #picker></mat-datepicker>
                            </mat-form-field>
                        </div>
                    </div>
                    <mat-divider></mat-divider>
                    <div class="row m-t-10">
                        <div class="col-sm-12 d-flex">
                            <mat-label class="f-w-600 d-block">{{ 'warehouse.common.productTotalAmount' | translate }}</mat-label>
                        </div>
                    </div>
                    <div class="row m-b-10">
                        <div class="col-sm-4 d-flex align-items-center p-t-10">
                            <mat-label class="f-w-600 d-block">{{ 'warehouse.common.shippingFee' | translate }}</mat-label>
                        </div>
                        <div class="col-sm-8">
                            <mat-form-field appearance="outline" class="input-height-46 w-100 position-relative">
                                <input [style.width.px]="120"
                                       (change)="onChangeShippingFee($event)" (keyup)="onChangeShippingFee($event)" matInput [type]="'text'" placeholder="0" />
                                <span style="position: absolute; right: 0"> ₫</span>
                            </mat-form-field>
                        </div>
                    </div>
                    <div class="row m-b-10">
                        <div class="col-sm-4 d-flex align-items-center">
                            <mat-label class="f-w-600 d-block">{{ 'warehouse.common.discount' | translate }}</mat-label>
                        </div>
                        <div class="col-sm-8">
                            <mat-form-field appearance="outline" class="input-height-46 w-100 position-relative">
                                <input [style.width.px]="120"
                                       (change)="onChangeDiscount($event)" (keyup)="onChangeDiscount($event)" matInput [type]="'text'" placeholder="0" />
                                <span style="position: absolute; right: 0"> %</span>
                            </mat-form-field>
                        </div>
                    </div>
                    <div class="row m-b-10">
                        <div class="col-sm-4 d-flex align-items-center">
                            <mat-label class="f-w-600 d-block">{{ 'warehouse.common.vat' | translate }}</mat-label>
                        </div>
                        <div class="col-sm-8">
                            <mat-form-field appearance="outline" class="input-height-46 w-100 position-relative">
                                <input [style.width.px]="120"
                                       (change)="onChangeVAT($event)" matInput [type]="'text'" placeholder="0" />
                                <span style="position: absolute; right: 0"> %</span>
                            </mat-form-field>
                        </div>
                    </div>
                    <div class="row m-b-10">
                        <div class="col-sm-4 d-flex align-items-center">
                            <mat-label class="f-w-600 d-block">{{ 'warehouse.common.total' | translate }}</mat-label>
                        </div>
                        <div class="col-sm-8">

                        </div>
                    </div>
                    <div class="row m-b-10">
                        <div class="col-sm-12 d-flex align-items-center">
                            <mat-label class="f-w-600 d-block m-b-10">{{ 'warehouse.common.note' | translate }}</mat-label>
                        </div>
                        <div class="col-sm-12">
                            <mat-form-field appearance="outline" class="w-100">
                                <textarea rows="5" matInput [disabled]="isLoading" placeholder="{{ 'warehouse.common.notePlaceholder' | translate }}" [(ngModel)]="note"></textarea>
                            </mat-form-field>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>
        <div class="col-lg-8 p-b-15">
            <mat-card class="cardWithShadow widget-container">
                <mat-card-content class="p-0">
                    <div class="p-t-0 d-lg-flex">
                        <button mat-mini-fab color="primary m-t-10 m-r-10 m-l-10" class="d-flex"
                                style="margin-top: 13px !important;"
                                (click)="fileInput.click()"
                                matTooltip="{{ 'warehouse.common.uploadFileExcel' | translate }}"
                                matTooltipPosition="above">
                            <i class="iconify icon-20 d-flex" data-icon="solar:upload-square-bold"></i>
                        </button>
                        <!-- Input file ẩn -->
                        <input type="file" hidden #fileInput (change)="onFileSelected($event)"  accept=".xlsx,.xls,.xlsm">
                        <app-warehouse-sku-select (onEventSkuSelected)="onEventSkuSelected($event)"></app-warehouse-sku-select>
                    </div>
                </mat-card-content>
            </mat-card>
            <mat-card class="cardWithShadow m-b-0">
                <mat-card-header class="p-15">
                    <mat-card-title class="m-b-0 text-black f-s-16">{{ 'warehouse.common.skus' | translate }}</mat-card-title>
                </mat-card-header>
                <mat-card-content class="p-0">
                    <mat-divider></mat-divider>
                    <div class="table-responsive" (scroll)="onScroll($event)">
                        <table mat-table [dataSource]="skus" class="w-100 table-default table-custom-small">
                            <ng-container matColumnDef="sellerSku">
                                <th mat-header-cell *matHeaderCellDef class="f-w-600 mat-subtitle-1 f-s-14 fixed-width-column sticky-col-1" [ngClass]="{ 'sticky-box-shadow-right': isTableScrolled }">
                                    {{ 'warehouse.inventory.common.sellerSku' | translate }}
                                </th>
                                <td mat-cell *matCellDef="let element" class="f-s-14 sticky-col-1" [ngClass]="{ 'sticky-box-shadow-right': isTableScrolled }">
                                    <div class="d-flex align-items-center gap-6">
                                        <div>
                                            <h5 class="f-s-15 f-w-700 m-t-4 m-b-0">{{ element?.seller_sku ?? 'N/A' }} <i-tabler *ngIf="element.seller_sku" (click)="copy(element.seller_sku)" name="copy" class="icon-12 cursor-pointer"></i-tabler></h5>
                                            <div class="m-t-3"><i-tabler name="hash" class="icon-12 cursor-pointer"></i-tabler>
                                                <span *ngFor="let field of element.fields">
                                                    <span>{{ field.name }}</span>: <span class="f-w-900">{{ field.value }}</span>,
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="productName">
                                <th mat-header-cell *matHeaderCellDef class="f-w-600 mat-subtitle-1 f-s-14">
                                    {{ 'warehouse.inventory.common.productCode' | translate }}
                                </th>
                                <td mat-cell *matCellDef="let element" class="mat-body-1">
                                    <h5 class="f-s-15 f-w-400 m-t-4 m-b-0 w-100 text-truncate cursor-pointer" style="max-width: 300px;"
                                        matTooltip="{{ element?.product?.name }}"
                                        matTooltipPosition="right">{{ element?.product?.name }}</h5>
                                    <div class="m-t-3">
                                        <i-tabler name="hash" class="icon-12 cursor-pointer"></i-tabler> {{ element?.product?.code }} <i-tabler *ngIf="element?.product?.code" (click)="copy(element?.product?.code)" name="copy" class="icon-12 cursor-pointer"></i-tabler>
                                    </div>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="image">
                                <th mat-header-cell *matHeaderCellDef class="f-w-600 mat-subtitle-1 f-s-14 fixed-width-column">
                                    {{ 'warehouse.inventory.common.image' | translate }}
                                </th>
                                <td mat-cell *matCellDef="let element" class="mat-body-1" [style.width.px]="100">
                                    <img alt="{{ element?.seller_sku }}" width="48" height="48" class="rounded cursor-pointer product-image"
                                         *ngIf="element?.images"
                                         appLazyLoadImage="{{ element?.images[0] }}" (error)="onImageError($event)" (click)="openLightBox(element?.seller_sku, element?.images[0])" />
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="onHandLogic">
                                <th mat-header-cell *matHeaderCellDef class="f-w-600 mat-subtitle-1 f-s-14 fixed-width-column text-right">
                                    {{ 'warehouse.common.onHandLogic' | translate }}
                                </th>
                                <td mat-cell *matCellDef="let element" class="mat-body-1 text-dark-200 text-right" [style.width.px]="120">
                                    {{ element?.onHandDb | number }}
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="quantity">
                                <th mat-header-cell *matHeaderCellDef class="f-w-600 mat-subtitle-1 f-s-14 fixed-width-column text-right">
                                    {{ 'labels.quantity' | translate }} ({{ totalItems | number }})
                                </th>
                                <td mat-cell *matCellDef="let element" class="mat-body-1 text-right text-dark-200 fixed-width-column" [style.width.px]="100">
                                    <mat-form-field [style.width.px]="80" class="input-height-46" appearance="outline">
                                        <input matInput [type]="'text'" (change)="onChangeQuantity($event, element)" [ngModel]="element?.quantity" />
                                    </mat-form-field>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="costPrice">
                                <th mat-header-cell *matHeaderCellDef class="f-w-600 mat-subtitle-1 f-s-14 fixed-width-column text-right">
                                    {{ 'warehouse.common.costPrice' | translate }}
                                </th>
                                <td mat-cell *matCellDef="let element" class="mat-body-1 text-dark-200 text-right" [style.width.px]="200">
                                    {{ element?.costPrice | number }} ₫
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="totalAmount">
                                <th mat-header-cell *matHeaderCellDef class="f-w-600 mat-subtitle-1 f-s-14 fixed-width-column text-right">
                                    {{ 'warehouse.common.totalAmount' | translate }}
                                </th>
                                <td mat-cell *matCellDef="let element" class="mat-body-1 text-dark-200 text-right" [style.width.px]="100">
                                    {{ element?.costPrice * element?.quantity  | number }} ₫
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef class="f-w-600 mat-subtitle-1 p-t-10 f-s-14 fixed-width-column text-center">
                                    <i-tabler class="icon-20" name="settings"></i-tabler>
                                </th>
                                <td mat-cell *matCellDef="let element" class="mat-body-1 text-center" [style.width.px]="70">
                                    <button mat-button class="d-flex"
                                            (click)="removeSku(element)"
                                            matTooltip="{{ 'buttons.remove' | translate }}"
                                            matTooltipPosition="above">
                                        <i class="iconify icon-20 d-flex text-error" data-icon="solar:trash-bin-trash-outline"></i>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                        </table>
                        <div class="text-center p-t-20 p-b-20" *ngIf="skus.length == 0">
                            <div class="text-muted">{{ 'common.noData' | translate }}</div>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
</mat-dialog-content>
<mat-dialog-actions align="end" class="p-10 dialog-actions bg-dark">
    <div class="m-r-20">
        <span class="text-dark-200">{{ 'warehouse.stocktaking.totalSku' | translate }}: <b>{{ totalSkus | number }}</b></span>
        <span class="p-l-20 p-r-20">|</span>
        <span class="text-dark-200">{{ 'warehouse.stocktaking.totalQuantityAfter' | translate }}: <b>{{ totalItems | number }}</b></span>
    </div>
    <button mat-stroked-button color="warn" mat-dialog-close>{{ 'buttons.close' | translate }}</button>
    <button mat-flat-button color="primary" (click)="onSave($event)" [disabled]="!skus.length">{{ 'buttons.save' | translate }}</button>
</mat-dialog-actions>
